<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Hardcore Punk Major7 Arpeggio Jam + Drums + Jianpu</title>
<script src="https://cdn.jsdelivr.net/npm/tone@14.7.77/build/Tone.min.js"></script>
<style>
  body { background:#121212; color:#eee; font-family: monospace; padding:1rem; }
  #output { white-space: pre-wrap; font-size:1.1rem; max-height: 400px; overflow-y: auto; border: 1px solid #444; padding: 0.8rem; }
  button { font-size:1.2rem; padding:0.6rem 1.4rem; margin-top:1rem; border:none; border-radius:5px; cursor:pointer; background:#333; color:#eee; }
  button:hover { background:#555; }
</style>
</head>
<body>

<h2>Hardcore Punk Major7 Arpeggio Jam + Drums + Jianpu</h2>
<button id="start">Start Jam</button>

<pre id="output">
=== Jam Log ===
</pre>

<script>
const JianpuMap = { 'C': '1', 'D': '2', 'E': '3', 'F': '4', 'G': '5', 'A': '6', 'B': '7' };
const major7Intervals = [0,4,7,11];
const roots = ['C','D','E','F','G','A','B'];

// Convert midi number to note letter (C, D, E, F, G, A, B)
function midiToNoteName(midi) {
  const names = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
  return names[midi % 12].replace('#','');
}

// Given root letter, interval semitones, return note letter (C,B,A...)
function noteFromRoot(root, interval) {
  const rootMidiMap = { C: 60, D: 62, E: 64, F: 65, G: 67, A: 69, B: 71 };
  let midi = rootMidiMap[root] + interval;
  return midiToNoteName(midi);
}

// Generate chord notes (Major7) letters from root
function generateMaj7Notes(root) {
  return major7Intervals.map(i => noteFromRoot(root, i));
}

// Jianpu format for notes array, 1 per line, spaced by octave if given
function toJianpu(notes) {
  return notes.map(note => JianpuMap[note] || '?').join(' ');
}

// Random shuffle array helper
function shuffle(array) {
  let arr = array.slice();
  for(let i=arr.length-1; i>0; i--){
    let j = Math.floor(Math.random()*(i+1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

// Section Patterns & roots
const sectionPatterns = [
  ['A','B','A','B'],
  ['A','A','B','B'],
  ['A','B','C','D'],
  ['A','B','C','C']
];
let sectionRoots = {};
function randomizeSectionRoots() {
  sectionRoots = {};
  ['A','B','C','D'].forEach(s => {
    sectionRoots[s] = roots[Math.floor(Math.random()*roots.length)];
  });
}

let currentPattern = [];
let currentSectionIndex = 0;
let measureCount = 0;

// Synths setup
const guitarSynth = new Tone.PolySynth(Tone.Synth, {
  oscillator: { type: 'square' },
  envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 0.05 }
}).toDestination();

const bassSynth = new Tone.MonoSynth({
  oscillator: { type: 'sawtooth' },
  filter: { Q: 2, type: 'lowpass', rolloff: -24 },
  envelope: { attack: 0.005, decay: 0.2, sustain: 0.5, release: 0.1 },
  filterEnvelope: { attack: 0.001, decay: 0.01, sustain: 0.5, release: 0.01, baseFrequency: 200, octaves: 2.6 }
}).toDestination();

const drumKick = new Tone.MembraneSynth({
  pitchDecay: 0.05,
  octaves: 10,
  envelope: { attack: 0.001, decay: 0.15, sustain: 0 },
  volume: -8
}).toDestination();

const drumSnare = new Tone.NoiseSynth({
  noise: { type: 'white' },
  envelope: { attack: 0.001, decay: 0.1, sustain: 0 },
  volume: -12
}).toDestination();

const drumHiHat = new Tone.MetalSynth({
  frequency: 6000,
  envelope: { attack: 0.001, decay: 0.05, release: 0.01 },
  harmonicity: 5.1,
  modulationIndex: 32,
  resonance: 6000,
  octaves: 1.5,
  volume: -15
}).toDestination();

// Hardcore punk drum pattern (8th notes at 220bpm)
// Kick on 1 & 3; snare on 2 & 4; hihat steady 8ths with some ghost notes
function scheduleDrums(measureNum) {
  const measureStart = `${measureNum}m`;
  for(let i=0; i<8; i++){
    let time = `${measureStart} + ${i*0.5}n`;
    // HiHat steady 8ths
    Tone.Transport.scheduleOnce(() => drumHiHat.triggerAttackRelease('16n'), time);
    // Kick on beats 1 & 3 (i=0,4)
    if(i === 0 || i === 4) {
      Tone.Transport.scheduleOnce(() => drumKick.triggerAttackRelease('8n'), time);
    }
    // Snare on beats 2 & 4 (i=2,6)
    if(i === 2 || i === 6) {
      Tone.Transport.scheduleOnce(() => drumSnare.triggerAttackRelease('16n'), time);
    }
    // Ghost snare very soft on 7th 16th note
    if(i === 7){
      Tone.Transport.scheduleOnce(() => drumSnare.triggerAttackRelease('32n', undefined, 0.15), time);
    }
  }
}

// Bass punk style: fast alternating root and octave on 8th notes
function scheduleBass(root, measureNum) {
  const rootMidiMap = { C: 'C2', D: 'D2', E: 'E2', F: 'F2', G: 'G2', A: 'A2', B: 'B2' };
  const octaveMidiMap = { C: 'C3', D: 'D3', E: 'E3', F: 'F3', G: 'G3', A: 'A3', B: 'B3' };
  const measureStart = `${measureNum}m`;
  for(let i=0; i<8; i++) {
    let time = `${measureStart} + ${i*0.5}n`;
    let note = (i % 2 === 0) ? rootMidiMap[root] : octaveMidiMap[root];
    Tone.Transport.scheduleOnce(() => bassSynth.triggerAttackRelease(note, '8n'), time);
  }
}

// Play guitar arpeggiated chord notes in random order during measure
function scheduleGuitar(root, measureNum) {
  const chordNotes = generateMaj7Notes(root);
  const shuffledNotes = shuffle(chordNotes);
  const measureStart = `${measureNum}m`;
  // 8 arpeggiated notes per measure at 16th note speed (~fast punk arpeggio)
  for(let i=0; i<8; i++) {
    let time = `${measureStart} + ${i*0.25}n`;
    let note = shuffledNotes[i % shuffledNotes.length] + '4';
    Tone.Transport.scheduleOnce(() => {
      guitarSynth.triggerAttackRelease(note, '16n');
    }, time);
  }
}

// Randomize and choose pattern and roots
function choosePattern() {
  currentPattern = sectionPatterns[Math.floor(Math.random()*sectionPatterns.length)];
  currentSectionIndex = 0;
  randomizeSectionRoots();
}

function playMeasure(time) {
  if(measureCount % 4 === 0){
    choosePattern();
  }
  const section = currentPattern[currentSectionIndex];
  const root = sectionRoots[section];

  scheduleGuitar(root, measureCount);
  scheduleBass(root, measureCount);
  scheduleDrums(measureCount);

  // Append Jianpu output for guitar notes (random arpeggio), bass roots, and drums
  const out = document.getElementById('output');
  out.textContent +=
`---
Measure ${measureCount + 1} | Section ${section} | Root: ${root}

Guitar Jianpu (random arpeggio notes):
${toJianpu(generateMaj7Notes(root))}

Bass Jianpu (root + octave fast 8ths):
${JianpuMap[root] || '?'} ${JianpuMap[root] || '?'} (alternating low & high)

Drums:
HiHat: steady 8ths
Kick: beats 1 & 3
Snare: beats 2 & 4 + ghost note

`;

  out.scrollTop = out.scrollHeight;

  measureCount++;
  currentSectionIndex = (currentSectionIndex + 1) % currentPattern.length;
}

document.getElementById('start').onclick = async () => {
  await Tone.start();
  measureCount = 0;
  choosePattern();
  Tone.Transport.bpm.value = 220;
  Tone.Transport.scheduleRepeat(playMeasure, '1m');
  Tone.Transport.start();
  document.getElementById('start').disabled = true;
  document.getElementById('start').textContent = 'Playing...';
};
</script>

</body>
</html>
