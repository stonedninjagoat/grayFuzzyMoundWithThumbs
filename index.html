<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Random Major7 Chords + Jianpu + Drums</title>
<script src="https://cdn.jsdelivr.net/npm/tone@14.7.77/build/Tone.min.js"></script>
<style>
  body { background:#111; color:#eee; font-family: monospace; padding: 1rem; }
  #output { white-space: pre-wrap; font-size: 1.3rem; }
  button { font-size: 1.2rem; margin-top: 1rem; padding: 0.7rem 1.5rem; cursor: pointer; border-radius: 6px; border:none; background:#333; color:#eee; }
  button:hover { background:#555; }
</style>
</head>
<body>

<h2>Random Major7 Guitar + Jianpu + Drums</h2>
<button id="start">Start Jam</button>

<div id="output">
Guitar Jianpu: -  
Bass Jianpu: -  
Drums Track1 (HiHat): -  
Drums Track2 (Kick/Snare): -
</div>

<script>
const JianpuMap = { 'C': '1', 'D': '2', 'E': '3', 'F': '4', 'G': '5', 'A': '6', 'B': '7' };

// Major7 intervals in semitones relative to root
const major7Intervals = [0,4,7,11];

// Notes for root selection (C major scale)
const roots = ['C','D','E','F','G','A','B'];

// Drum patterns for 8 eighth notes
const drumPatterns = {
  hihat: ['open', 'close', 'close', 'open', 'close', 'close', 'close', 'open'],
  kick:  [1,0,0,0,1,0,0,0],
  snare: [0,0,1,0,0,0,1,0]
};

// Utility: convert root + interval to note letter only (C,B etc)
function noteFromRoot(root, interval) {
  // MIDI note numbers for C4=60
  const midiMap = { C: 60, D: 62, E: 64, F: 65, G: 67, A: 69, B: 71 };
  let midi = midiMap[root] + interval;
  // Convert midi back to note letter (simplified, ignoring sharps)
  const noteNames = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
  let note = noteNames[midi % 12];
  if(note.includes('#')) {
    // For simplicity, just convert sharps down one semitone
    let altMidi = midi - 1;
    note = noteNames[altMidi % 12];
  }
  return note[0]; // just letter
}

// Generate random pairs of notes from Major7 chord
function generateMaj7Pairs(root) {
  // get chord notes (letters only)
  const chordNotes = major7Intervals.map(i => noteFromRoot(root, i));
  
  // possible pairs (unique pairs of 2 from 4 notes)
  let pairs = [];
  for(let i=0; i<chordNotes.length; i++) {
    for(let j=i+1; j<chordNotes.length; j++) {
      pairs.push([chordNotes[i], chordNotes[j]]);
    }
  }
  
  // shuffle pairs randomly
  pairs.sort(() => Math.random() - 0.5);
  
  // pick 3 pairs for the measure (like your example)
  return pairs.slice(0,3);
}

// Jianpu output for pairs (space separated)
function pairsToJianpu(pairs) {
  return pairs.map(pair => {
    return pair.map(note => JianpuMap[note] || '?').join(' ');
  }).join('\n');
}

// Jianpu output for drums track 1 (hihat)
function drumTrack1Jianpu() {
  return drumPatterns.hihat.map(h => h === 'open' ? '◯' : 'x').join('');
}

// Jianpu output for drums track 2 (kick + snare)
function drumTrack2Jianpu() {
  let result = '';
  for(let i=0; i<8; i++) {
    if(drumPatterns.kick[i] && drumPatterns.snare[i]) result += '◎'; // both kick+snare
    else if(drumPatterns.kick[i]) result += '●';
    else if(drumPatterns.snare[i]) result += '○';
    else result += '·';
  }
  return result;
}

// Simple random chord progression section pattern (e.g. ABAB)
const sectionPatterns = [
  ['A','B','A','B'],
  ['A','A','B','B'],
  ['A','B','C','D'],
  ['A','B','C','C']
];

// For each section letter assign random root chord
let sectionRoots = {};

// Initialize random chords for sections
function randomizeSectionRoots() {
  sectionRoots = {};
  ['A','B','C','D'].forEach(sec => {
    sectionRoots[sec] = roots[Math.floor(Math.random()*roots.length)];
  });
}

let measureCount = 0;
let currentPattern = [];
let currentSectionIndex = 0;

function choosePattern() {
  currentPattern = sectionPatterns[Math.floor(Math.random()*sectionPatterns.length)];
  currentSectionIndex = 0;
  randomizeSectionRoots();
}

function playMeasure(time) {
  if(measureCount % 4 === 0) {
    choosePattern();
  }
  const section = currentPattern[currentSectionIndex];
  const root = sectionRoots[section];

  // Guitar pairs
  const guitarPairs = generateMaj7Pairs(root);

  // Output Jianpu
  document.getElementById('output').textContent = 
`Guitar Jianpu:
${pairsToJianpu(guitarPairs)}

Bass Jianpu:
${JianpuMap[root] || '?'}

Drums Track1 (HiHat):
${drumTrack1Jianpu()}

Drums Track2 (Kick/Snare):
${drumTrack2Jianpu()}`;

  measureCount++;
  currentSectionIndex = (currentSectionIndex + 1) % currentPattern.length;
}

function startJam() {
  Tone.Transport.bpm.value = 200;
  Tone.Transport.scheduleRepeat(playMeasure, '1m');
  Tone.Transport.start();
}

document.getElementById('start').onclick = async () => {
  await Tone.start();
  choosePattern();
  startJam();
  document.getElementById('start').disabled = true;
  document.getElementById('start').textContent = 'Playing...';
};
</script>

</body>
</html>
