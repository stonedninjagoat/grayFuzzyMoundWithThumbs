<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Hardcore Major7 Jam + Jianpu Output</title>
<script src="https://cdn.jsdelivr.net/npm/tone@14.7.77/build/Tone.min.js"></script>
<style>
  body { background: #121212; color: #eee; font-family: monospace, monospace; padding: 1rem; }
  #jianpuOutput { white-space: pre-wrap; margin-top: 1rem; font-size: 1.3rem; }
  #sectionDisplay { font-weight: bold; font-size: 1.5rem; margin-top: 1rem; }
  button { font-size: 1.2rem; margin-top: 1rem; padding: 0.7rem 1.5rem; cursor: pointer; border-radius: 6px; border:none; background: #333; color: #eee; }
  button:hover { background: #555; }
</style>
</head>
<body>

<h2>Hardcore Jam with Major7 Guitar + Hardcore Bass + Drums + Jianpu Output</h2>

<div id="sectionDisplay">Section: -</div>
<div id="jianpuOutput">
Guitar Jianpu: -  
Bass Jianpu: -  
Drums Jianpu: -
</div>
<button id="startButton">Start Jam</button>

<script>
const Tone = window.Tone;
const startBtn = document.getElementById('startButton');
const jianpuDiv = document.getElementById('jianpuOutput');
const sectionDiv = document.getElementById('sectionDisplay');

const JianpuMap = { 'C':'1', 'D':'2', 'E':'3', 'F':'4', 'G':'5', 'A':'6', 'B':'7' };

const major7Intervals = [0,4,7,11];   // semitones from root
const bassIntervals = [0,12,7];       // root, octave, 5th for hardcore bass harmony

const noteToMidi = { 'C':60, 'D':62, 'E':64, 'F':65, 'G':67, 'A':69, 'B':71 };

const chordProgressions = {
  A: ['C', 'E', 'F', 'G'],
  B: ['A', 'D', 'E', 'F'],
  C: ['G', 'A', 'B', 'C'],
  D: ['E', 'F', 'G', 'A']
};

const sectionPatterns = [
  ['A','B','A','B'],
  ['A','A','B','B'],
  ['A','B','C','D'],
  ['A','B','C','C']
];

// Drums pattern per 1 measure (8 eighth notes)
const drumPattern = {
  kick:  [1,0,0,0,1,0,0,0],
  snare: [0,0,1,0,0,0,1,0],
  hihat: [1,1,1,1,1,1,1,1]
};

// Load drum samples
const drums = new Tone.Players({
  kick: "https://tonejs.github.io/audio/drum-samples/breakbeat/kick.mp3",
  snare: "https://tonejs.github.io/audio/drum-samples/breakbeat/snare.mp3",
  hihat: "https://tonejs.github.io/audio/drum-samples/breakbeat/hihat.mp3"
}).toDestination();

// Guitar sampler + distortion for Maj7 chords
const guitar = new Tone.Sampler({
  urls: {
    "C4": "C4.mp3",
    "D4": "D4.mp3",
    "E4": "E4.mp3",
    "F4": "F4.mp3",
    "G4": "G4.mp3",
    "A4": "A4.mp3",
    "B4": "B4.mp3",
  },
  baseUrl: "https://tonejs.github.io/audio/salamander/",
}).chain(new Tone.Distortion(0.8), Tone.Destination);

// Bass sampler
const bass = new Tone.Sampler({
  urls: {
    "C2": "C2.mp3",
    "D2": "D2.mp3",
    "E2": "E2.mp3",
    "F2": "F2.mp3",
    "G2": "G2.mp3",
    "A2": "A2.mp3",
    "B2": "B2.mp3",
  },
  baseUrl: "https://tonejs.github.io/audio/salamander/",
}).toDestination();

function midiToNoteName(midi) {
  const notes = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
  return notes[midi % 12] + (Math.floor(midi/12)-1);
}

function playMaj7Chord(root, time) {
  const rootMidi = noteToMidi[root];
  if (!rootMidi) return;
  major7Intervals.forEach(interval => {
    const note = midiToNoteName(rootMidi + interval);
    guitar.triggerAttackRelease(note, "2n", time);
  });
}

function playBassHarmony(root, time) {
  const rootMidi = noteToMidi[root];
  if (!rootMidi) return;
  bassIntervals.forEach(interval => {
    const note = midiToNoteName(rootMidi + interval);
    bass.triggerAttackRelease(note, "2n", time);
  });
}

function playDrums(time) {
  const eighthNoteDur = Tone.Time("8n").toSeconds();
  for(let i=0; i<8; i++) {
    const t = time + i*eighthNoteDur;
    if(drumPattern.kick[i]) drums.player("kick").start(t);
    if(drumPattern.snare[i]) drums.player("snare").start(t);
    if(drumPattern.hihat[i]) drums.player("hihat").start(t);
  }
}

function chordsToJianpu(chords) {
  return chords.map(c => JianpuMap[c] || '?').join(' ');
}

function drumPatternToJianpu(arr) {
  return arr.map(v => v ? '●' : '·').join('');
}

let measureCount = 0;
let currentPattern = [];
let currentSectionIndex = 0;

function choosePattern() {
  currentPattern = sectionPatterns[Math.floor(Math.random()*sectionPatterns.length)];
  currentSectionIndex = 0;
}

function scheduleMeasure(time) {
  if (measureCount % 16 === 0) choosePattern();

  const section = currentPattern[currentSectionIndex];
  const chords = chordProgressions[section];

  // Play each chord on quarter notes
  chords.forEach((root, i) => {
    const noteTime = time + i * Tone.Time("4n").toSeconds();
    playMaj7Chord(root, noteTime);
    playBassHarmony(root, noteTime);
  });

  // Drums on whole measure
  playDrums(time);

  // Update Jianpu display
  sectionDiv.textContent = `Section: ${section}`;
  jianpuDiv.textContent = 
    `Guitar Jianpu: ${chordsToJianpu(chords)}\n` +
    `Bass Jianpu: ${chordsToJianpu(chords)}\n` +
    `Drums Jianpu:\n  Kick: ${drumPatternToJianpu(drumPattern.kick)}\n  Snare: ${drumPatternToJianpu(drumPattern.snare)}\n  HiHat: ${drumPatternToJianpu(drumPattern.hihat)}`;

  measureCount++;
  currentSectionIndex = (currentSectionIndex + 1) % currentPattern.length;
}

function startJam() {
  Tone.Transport.bpm.value = 220;
  Tone.Transport.scheduleRepeat(scheduleMeasure, "1m");
  Tone.Transport.start();
}

startBtn.onclick = async () => {
  await Tone.start();
  startJam();
  startBtn.disabled = true;
  startBtn.textContent = "Playing...";
};
</script>

</body>
</html>
