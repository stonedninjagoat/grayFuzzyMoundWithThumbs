<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CSV to MIDI Converter</title>
  <script src="https://cdn.jsdelivr.net/npm/jsmidgen@latest/dist/jsmidgen.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@magenta/music@1.22.1/es6/core.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@magenta/music@1.22.1/es6/midi_io.js"></script>
</head>
<body>
  <h2>CSV to MIDI Converter</h2>

  <label for="tempo">Tempo (BPM):</label>
  <input type="number" id="tempo" value="120" min="30" max="300" />
  <br><br>

  <input type="file" id="csvFile" accept=".csv" />
  <button onclick="convertCSVtoMIDI()">Convert & Generate MIDI</button>

  <br><br>
  <button id="playButton" style="display:none;" onclick="playMIDI()">â–¶ Play MIDI</button>
  <br><br>
  <a id="downloadLink" style="display: none;" download="converted.mid">Download MIDI File</a>

  <script>
    let midiBlob = null;

    function convertCSVtoMIDI() {
      const fileInput = document.getElementById('csvFile');
      const tempo = parseInt(document.getElementById('tempo').value) || 120;

      if (!fileInput.files.length) {
        alert('Please upload a CSV file.');
        return;
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        const csv = e.target.result;
        const lines = csv.split(/\r?\n/).map(l => l.trim()).filter(l => l !== '');
        const midiNumbers = lines.map(n => parseInt(n)).filter(n => !isNaN(n));

        if (midiNumbers.length === 0) {
          alert('CSV does not contain valid MIDI numbers.');
          return;
        }

        const file = new Midi.File();
        const track = new Midi.Track();
        file.addTrack(track);

        const TICKS_PER_BEAT = 128;
        const durationTicks = TICKS_PER_BEAT / 2; // 1/8 note
        const microsecondsPerBeat = Math.floor(60000000 / tempo);
        track.setTempo(microsecondsPerBeat);

        for (let note of midiNumbers) {
          track.addNote(0, note, durationTicks);
        }

        const midiString = file.toBytes();
        const byteArray = new Uint8Array(midiString.length);
        for (let i = 0; i < midiString.length; i++) {
          byteArray[i] = midiString.charCodeAt(i);
        }

        midiBlob = new Blob([byteArray], { type: 'audio/midi' });
        const url = URL.createObjectURL(midiBlob);

        // Set download link
        const downloadLink = document.getElementById('downloadLink');
        downloadLink.href = url;
        downloadLink.style.display = 'inline';

        // Show play button
        document.getElementById('playButton').style.display = 'inline';
      };

      reader.readAsText(fileInput.files[0]);
    }

    async function playMIDI() {
      if (!midiBlob) return;

      const arrayBuffer = await midiBlob.arrayBuffer();
      const midi = new core.MIDIFile(arrayBuffer);
      const noteSeq = mm.midiToSequenceProto(midi);

      const player = new mm.SoundFontPlayer('https://storage.googleapis.com/magentadata/js/soundfonts/sgm_plus');
      await player.initialize();
      player.start(noteSeq);
    }
  </script>
</body>
</html>
