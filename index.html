<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CSV to MIDI Converter</title>
  <script src="https://cdn.jsdelivr.net/npm/jsmidgen@latest/dist/jsmidgen.min.js"></script>
</head>
<body>
  <h2>CSV to MIDI Converter</h2>

  <label for="tempo">Tempo (BPM):</label>
  <input type="number" id="tempo" value="120" min="30" max="300" />
  <br><br>

  <input type="file" id="csvFile" accept=".csv" />
  <button onclick="convertCSVtoMIDI()">Convert & Generate MIDI</button>

  <br><br>
  <audio id="midiPlayer" controls></audio>
  <br><br>
  <a id="downloadLink" style="display: none;" download="converted.mid">Download MIDI File</a>

  <script>
    function convertCSVtoMIDI() {
      const fileInput = document.getElementById('csvFile');
      const tempo = parseInt(document.getElementById('tempo').value) || 120;

      if (!fileInput.files.length) {
        alert('Please upload a CSV file.');
        return;
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        const csv = e.target.result;
        const lines = csv.split(/\r?\n/).map(l => l.trim()).filter(l => l !== '');
        const midiNumbers = lines.map(n => parseInt(n)).filter(n => !isNaN(n));

        if (midiNumbers.length === 0) {
          alert('CSV does not contain valid MIDI numbers.');
          return;
        }

        const file = new Midi.File();
        const track = new Midi.Track();
        file.addTrack(track);

        // Convert BPM to microseconds per beat
        const microsecondsPerBeat = Math.floor(60000000 / tempo);
        track.setTempo(microsecondsPerBeat);

        const TICKS_PER_BEAT = 128;
        const durationTicks = TICKS_PER_BEAT / 2; // 1/8 note

        for (let note of midiNumbers) {
          track.addNote(0, note, durationTicks);
        }

        const midiData = file.toBytes();
        const blob = new Blob([new Uint8Array(midiData.split('').map(c => c.charCodeAt(0)))], { type: 'audio/midi' });
        const url = URL.createObjectURL(blob);

        const player = document.getElementById('midiPlayer');
        player.src = url;

        const downloadLink = document.getElementById('downloadLink');
        downloadLink.href = url;
        downloadLink.style.display = 'inline';
      };

      reader.readAsText(fileInput.files[0]);
    }
  </script>
</body>
</html>
