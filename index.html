// === Setup Instruments ===

const powerChords = {
  "C": ["C4", "G4"],
  "D": ["D4", "A4"],
  "E": ["E4", "B4"],
  "F": ["F4", "C5"],
  "G": ["G3", "D4"],
  "A": ["A3", "E4"],
  "B": ["B3", "F#4"]
};
const roots = Object.keys(powerChords);

const guitar = new Tone.PolySynth(Tone.MonoSynth, {
  oscillator: { type: "square" },
  envelope: { attack: 0.005, decay: 0.2, sustain: 0.1, release: 0.2 }
}).chain(new Tone.Distortion(0.7), Tone.Destination);

const bass = new Tone.MonoSynth({
  oscillator: { type: "sawtooth" },
  filter: { type: "lowpass", frequency: 120 },
  envelope: { attack: 0.01, decay: 0.3, sustain: 0.2, release: 0.3 }
}).toDestination();

// Drum samplers track 1 (kick & snare)
const drumsTrack1 = new Tone.Sampler({
  urls: {
    "C1": "kick.wav",
    "D1": "snare.wav",
  },
  baseUrl: "https://tonejs.github.io/audio/drum-samples/CR78/",
}).toDestination();

// Drum samplers track 2 (open and closed hi-hat)
const drumsTrack2 = new Tone.Sampler({
  urls: {
    "E1": "openhat.wav",
    "F1": "closedhat.wav",
  },
  baseUrl: "https://tonejs.github.io/audio/drum-samples/CR78/",
}).toDestination();

// === Musical params ===
const beatsPerMeasure = 4;
const measuresPerPhrase = 4;
const stepsPerPhrase = beatsPerMeasure * measuresPerPhrase; // 16 steps per phrase (quarter notes)

// Generate one phrase with random notes
function generatePhrase() {
  const phrase = [];
  for (let step = 0; step < stepsPerPhrase; step++) {
    // Guitar chord root or rest (80% chance to play)
    const guitarRoot = Math.random() < 0.8 ? roots[Math.floor(Math.random() * roots.length)] : null;
    const bassNote = guitarRoot ? guitarRoot + "2" : null;

    // Drums:
    // Track 1: Kick on beats 1 & 3, snare on 2 & 4 of each measure
    // Track 2: Closed hi-hat on every beat, open hi-hat on off-beats (simulate with quarter note resolution, randomly open or closed)
    const beatInMeasure = step % beatsPerMeasure;
    const drumsStep = {
      kick: beatInMeasure === 0 || beatInMeasure === 2,
      snare: beatInMeasure === 1 || beatInMeasure === 3,
      openHiHat: Math.random() < 0.25,  // 25% chance open hi-hat, otherwise closed
      closedHiHat: true
    };

    phrase.push({
      guitar: guitarRoot,
      bass: bassNote,
      drums: drumsStep
    });
  }
  return phrase;
}

// Convert phrase to text with | measure dividers and two percussion tracks separated
function phraseToText(phrase) {
  let guitarLine = "";
  let bassLine = "";
  let drums1Line = ""; // kick + snare
  let drums2Line = ""; // open and closed hi-hat

  for (let i = 0; i < phrase.length; i++) {
    const step = phrase[i];

    // Add measure divider
    if (i > 0 && i % beatsPerMeasure === 0) {
      guitarLine += " | ";
      bassLine += " | ";
      drums1Line += " | ";
      drums2Line += " | ";
    }

    // Guitar: root or '-'
    guitarLine += step.guitar ? step.guitar : "-";

    // Bass: root first char or '-'
    bassLine += step.bass ? step.bass[0] : "-";

    // Drums track 1 (kick & snare)
    let d1 = "";
    if (step.drums.kick) d1 += "K";
    if (step.drums.snare) d1 += "S";
    drums1Line += d1.padEnd(2, " ");

    // Drums track 2 (hi-hats)
    if (step.drums.openHiHat) {
      drums2Line += "o "; // open hi-hat
    } else if (step.drums.closedHiHat) {
      drums2Line += "c "; // closed hi-hat
    } else {
      drums2Line += "- ";
    }
  }

  return {
    guitarLine,
    bassLine,
    drums1Line,
    drums2Line
  };
}

// Play a phrase at a given start time
function playPhrase(phrase, startTime) {
  for (let step = 0; step < phrase.length; step++) {
    const stepData = phrase[step];
    const time = startTime + step * Tone.Time("4n").toSeconds();

    if (stepData.guitar) {
      const chord = powerChords[stepData.guitar];
      guitar.triggerAttackRelease(chord, "8n", time);
    }
    if (stepData.bass) {
      bass.triggerAttackRelease(stepData.bass, "8n", time);
    }

    // Track 1 drums
    if (stepData.drums.kick) drumsTrack1.triggerAttackRelease("C1", "16n", time);
    if (stepData.drums.snare) drumsTrack1.triggerAttackRelease("D1", "16n", time + 0.05);

    // Track 2 drums
    if (stepData.drums.openHiHat) drumsTrack2.triggerAttackRelease("E1", "16n", time + 0.1);
    else if (stepData.drums.closedHiHat) drumsTrack2.triggerAttackRelease("F1", "16n", time + 0.1);
  }
}
