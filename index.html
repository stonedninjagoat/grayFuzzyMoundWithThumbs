<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CSV to MIDI (Tone.js)</title>
  <script src="https://cdn.jsdelivr.net/npm/tone@next/build/Tone.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.27/build/Midi.js"></script>
</head>
<body>
  <h2>CSV to MIDI Converter (Tone.js)</h2>
  <input type="file" id="csvFile" accept=".csv" />
  <br><br>
  <button onclick="playNotes()">Play MIDI</button>
  <button onclick="downloadMIDI()">Download MIDI</button>

  <script>
    let midiNotes = [];

    document.getElementById('csvFile').addEventListener('change', async function(event) {
      const file = event.target.files[0];
      if (!file) return;

      const text = await file.text();
      const lines = text.trim().split(/\r?\n/);
      midiNotes = [];

      for (let line of lines) {
        const parts = line.split(',');
        for (let part of parts) {
          const num = parseInt(part.trim());
          if (!isNaN(num)) midiNotes.push(num);
        }
      }

      alert(`Loaded ${midiNotes.length} MIDI notes.`);
    });

    async function playNotes() {
      if (midiNotes.length === 0) {
        alert("Please load a CSV file first.");
        return;
      }

      await Tone.start(); // Required for modern browsers

      const synth = new Tone.Synth().toDestination();
      let time = 0;
      const duration = 0.4;

      midiNotes.forEach((midi, index) => {
        const freq = Tone.Frequency(midi, "midi");
        Tone.Transport.scheduleOnce(time => {
          synth.triggerAttackRelease(freq, duration, time);
        }, `+${index * duration}`);
      });

      Tone.Transport.start();
    }

    function downloadMIDI() {
      if (midiNotes.length === 0) {
        alert("Please load a CSV file first.");
        return;
      }

      const midi = new Midi();
      const track = midi.addTrack();

      let time = 0;
      const duration = 0.5; // in seconds

      for (let note of midiNotes) {
        track.addNote({
          midi: note,
          time: time,
          duration: duration
        });
        time += duration;
      }

      const bytes = midi.toArray();
      const blob = new Blob([bytes], { type: "audio/midi" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "converted.mid";
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
